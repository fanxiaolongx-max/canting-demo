<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¿ƒå£°å¢™</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, "Microsoft YaHei", sans-serif; }
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh;
            padding-bottom: 80px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .header {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .header p { font-size: 13px; opacity: 0.9; }

        .stats {
            display: flex;
            gap: 20px;
            padding: 15px 20px;
            color: white;
            font-size: 13px;
        }
        .stat-item { display: flex; align-items: center; gap: 5px; }

        .posts-container {
            padding: 10px 20px;
        }

        .post-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .post-author {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #666;
        }
        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }
        .post-time {
            font-size: 12px;
            color: #999;
        }

        .post-content {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            margin-bottom: 12px;
        }

        .post-footer {
            display: flex;
            gap: 15px;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }
        .post-action {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #999;
            font-size: 13px;
            cursor: pointer;
            transition: 0.2s;
        }
        .post-action:active {
            transform: scale(0.95);
        }
        .post-action.liked {
            color: #e91e63;
        }

        /* è¯„è®ºåŒºåŸŸ */
        .comments-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
        }
        .comment-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #f5f5f5;
            position: relative;
        }
        .comment-item:last-child {
            border-bottom: none;
        }
        .comment-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            flex-shrink: 0;
        }
        .comment-content {
            flex: 1;
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }
        .comment-time {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
        }
        .comment-delete-btn {
            background: none;
            border: none;
            color: #999;
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
            opacity: 0.7;
            transition: 0.2s;
            flex-shrink: 0;
            align-self: flex-start;
            margin-top: 2px;
        }
        .comment-delete-btn:hover {
            opacity: 1;
            color: #e91e63;
            transform: scale(1.1);
        }
        .comment-delete-btn:active {
            transform: scale(0.9);
        }
        .comment-input-box {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .comment-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 13px;
            outline: none;
        }
        .comment-input:focus {
            border-color: #667eea;
        }
        .comment-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
        }
        .comment-btn:active {
            transform: scale(0.95);
        }
        .show-comments-btn {
            color: #667eea;
            font-size: 12px;
            cursor: pointer;
            margin-top: 8px;
        }

        /* åˆ†é¡µ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 20px;
            color: white;
        }
        .page-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .page-btn:active {
            background: rgba(255,255,255,0.3);
        }
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .page-info {
            font-size: 13px;
        }

        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 28px;
            border: none;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
        }
        .fab:active {
            transform: scale(0.9);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 500px;
        }
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .modal-textarea {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            font-size: 15px;
            resize: none;
            height: 120px;
            font-family: inherit;
        }
        .modal-textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .char-count {
            text-align: right;
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: 0.3s;
        }
        .modal-btn.cancel {
            background: #f5f5f5;
            color: #666;
        }
        .modal-btn.submit {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .modal-btn:active {
            transform: scale(0.95);
        }

        .empty {
            text-align: center;
            color: white;
            padding: 80px 20px;
        }
        .empty-icon { font-size: 64px; margin-bottom: 10px; }

        .loading {
            text-align: center;
            color: white;
            padding: 40px;
        }

        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ’¬ å¿ƒå£°å¢™</h1>
        <p>åŒ¿ååˆ†äº«ä½ çš„æƒ³æ³•å’Œå»ºè®®</p>
    </div>

    <div class="stats">
        <div class="stat-item">
            <span>ğŸ“</span>
            <span>å…± <strong id="total-posts">0</strong> æ¡å¿ƒå£°</span>
        </div>
        <div class="stat-item">
            <span>â¤ï¸</span>
            <span>ç´¯è®¡ <strong id="total-likes">0</strong> ä¸ªèµ</span>
        </div>
    </div>

    <div class="posts-container" id="posts-container">
        <div class="loading">åŠ è½½ä¸­...</div>
    </div>

    <div class="pagination" id="pagination"></div>

    <button class="fab" onclick="openModal()">âœï¸</button>

    <div class="modal" id="post-modal">
        <div class="modal-content">
            <div class="modal-title">âœï¸ å‘è¡¨å¿ƒå£°</div>
            <textarea 
                class="modal-textarea" 
                id="post-content" 
                placeholder="è¯´è¯´ä½ çš„æƒ³æ³•...&#10;&#10;â€¢ åŒ¿åå‘å¸ƒï¼Œæ”¾å¿ƒåæ§½&#10;â€¢ è¯·æ–‡æ˜ç”¨è¯­ï¼Œç†æ€§è¡¨è¾¾"
                maxlength="500"
                oninput="updateCharCount()"
            ></textarea>
            <div class="char-count">
                <span id="char-count">0</span> / 500
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="modal-btn submit" onclick="submitPost()">å‘å¸ƒ</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let posts = [];
        let myLikes = JSON.parse(localStorage.getItem('forum_likes') || '[]');
        let currentPage = 1;
        let totalPages = 1;
        let totalCount = 0;

        // ç”Ÿæˆæˆ–è·å–è®¾å¤‡å”¯ä¸€ID
        function getDeviceId() {
            let deviceId = localStorage.getItem('forum_device_id');
            if (!deviceId) {
                // ç”Ÿæˆå”¯ä¸€IDï¼šæ—¶é—´æˆ³ + éšæœºæ•°
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('forum_device_id', deviceId);
            }
            return deviceId;
        }

        // ç”Ÿæˆå›ºå®šçš„åŒ¿ååç§°ï¼ˆåŸºäºdevice_idï¼‰
        function getAnonymousName(deviceId) {
            if (!deviceId) return 'åŒ¿åç”¨æˆ·';
            
            // å¯çˆ±çš„å½¢å®¹è¯åˆ—è¡¨
            const adjectives = [
                'è½¯èŒ', 'ç”œå¿ƒ', 'å°å¯çˆ±', 'èŒèŒ', 'è½¯è½¯', 'ç”œç”œ', 'æš–æš–', 'å°æ˜Ÿæ˜Ÿ',
                'ç²‰ç²‰', 'è“è“', 'ç»¿ç»¿', 'é»„é»„', 'ç´«ç´«', 'æ©™æ©™', 'å½©è™¹', 'äº‘æœµ',
                'æ¯›èŒ¸èŒ¸', 'åœ†æ»šæ»š', 'èƒ–ä¹ä¹', 'äº®æ™¶æ™¶', 'æ°´æ±ªæ±ª', 'ç¬‘çœ¯çœ¯', 'ç¬‘å˜»å˜»', 'ä¹å‘µå‘µ',
                'é¦™å–·å–·', 'ç”œæ»‹æ»‹', 'é…¸æºœæºœ', 'è¾£ä¹ä¹', 'çƒ­ä¹ä¹', 'å‡‰ä¸ä¸', 'æ»‘æºœæºœ', 'è½¯ç»µç»µ'
            ];
            
            // å¯çˆ±çš„åè¯åˆ—è¡¨
            const nouns = [
                'å°å…”', 'å°ç†Š', 'å°çŒ«', 'å°ç‹—', 'å°é¸Ÿ', 'å°é±¼', 'å°é¹¿', 'å°ç¾Š',
                'è‰è“', 'æ¨±æ¡ƒ', 'è‹¹æœ', 'æ©™å­', 'è‘¡è„', 'è¥¿ç“œ', 'èœœæ¡ƒ', 'èŠ’æœ',
                'æœˆäº®', 'æ˜Ÿæ˜Ÿ', 'å¤ªé˜³', 'å½©è™¹', 'äº‘æœµ', 'é›ªèŠ±', 'é›¨æ»´', 'å¾®é£',
                'æ£‰èŠ±', 'ç³–æœ', 'è›‹ç³•', 'é¥¼å¹²', 'å¥¶èŒ¶', 'å’–å•¡', 'æœæ±', 'å†°æ·‡æ·‹',
                'å°ç²¾çµ', 'å°å¤©ä½¿', 'å°å…¬ä¸»', 'å°ç‹å­', 'å°å®è´', 'å°ç”œå¿ƒ', 'å°æ˜Ÿæ˜Ÿ', 'å°æœˆäº®',
                'å°äº‘æœµ', 'å°å½©è™¹', 'å°é›ªèŠ±', 'å°é›¨æ»´', 'å°å¾®é£', 'å°é˜³å…‰', 'å°èŠ±æœµ', 'å°å¶å­'
            ];
            
            // ä½¿ç”¨device_idç”Ÿæˆå›ºå®šçš„éšæœºæ•°ç§å­
            let hash = 0;
            for (let i = 0; i < deviceId.length; i++) {
                const char = deviceId.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
            }
            
            // ç¡®ä¿hashä¸ºæ­£æ•°
            hash = Math.abs(hash);
            
            // æ ¹æ®hashé€‰æ‹©å½¢å®¹è¯å’Œåè¯ï¼ˆä½¿ç”¨ä¸åŒçš„hashå€¼ç¡®ä¿ç»„åˆå¤šæ ·ï¼‰
            const adjIndex = hash % adjectives.length;
            const nounHash = Math.floor(hash / 1000); // ä½¿ç”¨ä¸åŒçš„hashå€¼
            const nounIndex = Math.abs(nounHash) % nouns.length;
            
            // ç”Ÿæˆæ•°å­—åç¼€ï¼ˆ1-999ï¼‰
            const number = (hash % 999) + 1;
            
            return `${adjectives[adjIndex]}${nouns[nounIndex]}${number}`;
        }

        // åŠ è½½å¸–å­ï¼ˆæ”¯æŒåˆ†é¡µï¼‰
        function loadPosts(page = 1) {
            currentPage = page;
            const myDeviceId = getDeviceId();
            console.log('ğŸ” åŠ è½½å¸–å­ï¼Œå½“å‰è®¾å¤‡ID:', myDeviceId);
            
            fetch(`/api/forum/posts?page=${page}&pageSize=20`)
                .then(res => res.json())
                .then(data => {
                    posts = data.posts || [];
                    
                    // è°ƒè¯•ï¼šè¾“å‡ºè¯„è®ºä¿¡æ¯
                    posts.forEach(post => {
                        if (post.comments && post.comments.length > 0) {
                            console.log(`ğŸ“ å¸–å­ ${post.id} çš„è¯„è®º:`, post.comments.map(c => ({
                                id: c.id,
                                device_id: c.device_id,
                                isMyComment: c.device_id === myDeviceId,
                                timestamp: new Date(c.timestamp).toLocaleString()
                            })));
                        }
                    });
                    totalPages = data.pagination?.totalPages || 1;
                    totalCount = data.pagination?.totalCount || 0;
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ—§è¯„è®ºï¼ˆæ²¡æœ‰device_idï¼‰
                    let hasOldComments = false;
                    posts.forEach(post => {
                        if (post.comments && post.comments.some(c => !c.device_id)) {
                            hasOldComments = true;
                        }
                    });
                    
                    if (hasOldComments) {
                        console.warn('âš ï¸ æ£€æµ‹åˆ°æ—§è¯„è®ºï¼ˆæ²¡æœ‰device_idï¼‰ï¼Œè¿™äº›è¯„è®ºæ— æ³•åˆ é™¤ã€‚è¯·å‘å¸ƒæ–°è¯„è®ºæ¥æµ‹è¯•åˆ é™¤åŠŸèƒ½ã€‚');
                    }
                    
                    renderPosts();
                    renderPagination();
                    updateStats();
                })
                .catch(err => {
                    document.getElementById('posts-container').innerHTML = 
                        '<div class="empty"><div class="empty-icon">ğŸ˜•</div><p>åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</p></div>';
                    console.error(err);
                });
        }

        // æ¸²æŸ“å¸–å­
        function renderPosts() {
            const container = document.getElementById('posts-container');
            
            if (posts.length === 0) {
                container.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“­</div><p>è¿˜æ²¡æœ‰å¿ƒå£°ï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡å§ï¼</p></div>';
                return;
            }

            container.innerHTML = posts.map((post, index) => {
                const isLiked = myLikes.includes(post.id);
                const timeAgo = getTimeAgo(post.timestamp);
                const comments = post.comments || [];
                const hasComments = comments.length > 0;
                const myDeviceId = getDeviceId();
                const isMyPost = post.device_id && post.device_id === myDeviceId;
                const withinTimeLimit = canDeleteComment(post.timestamp);
                const canDeletePost = isMyPost && withinTimeLimit;
                
                return `
                    <div class="post-card" id="post-${post.id}">
                        <div class="post-header">
                            <div class="post-author">
                                <div class="avatar">${getAvatar(post.device_id || post.id)}</div>
                                <span>${post.device_id ? getAnonymousName(post.device_id) : 'åŒ¿åç”¨æˆ· #' + String(post.id).slice(-4)}</span>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div class="post-time">${timeAgo}${canDeletePost ? ' Â· <span style="color: #ff9800;">å¯åˆ é™¤</span>' : ''}</div>
                                ${canDeletePost ? `
                                    <button class="comment-delete-btn" onclick="deletePost(${post.id})" title="åˆ é™¤å¸–å­ï¼ˆ30åˆ†é’Ÿå†…ï¼Œä¼šåŒæ—¶åˆ é™¤æ‰€æœ‰è¯„è®ºï¼‰">
                                        ğŸ—‘ï¸
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="post-content">${escapeHtml(post.content)}</div>
                        <div class="post-footer">
                            <div class="post-action ${isLiked ? 'liked' : ''}" onclick="toggleLike(${post.id}, event)">
                                <span>${isLiked ? 'â¤ï¸' : 'ğŸ¤'}</span>
                                <span id="like-count-${post.id}">${post.likes}</span>
                            </div>
                            <div class="post-action" onclick="toggleCommentInput(${post.id})">
                                ğŸ’¬ ${comments.length}
                            </div>
                        </div>
                        ${hasComments ? `
                            <div class="comments-section" id="comments-${post.id}">
                                ${comments.map(comment => {
                                    const myDeviceId = getDeviceId();
                                    // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå·±çš„è¯„è®º
                                    const isMyComment = comment.device_id && comment.device_id === myDeviceId;
                                    // æ£€æŸ¥æ˜¯å¦åœ¨30åˆ†é’Ÿå†…
                                    const withinTimeLimit = canDeleteComment(comment.timestamp);
                                    // å¯ä»¥åˆ é™¤çš„æ¡ä»¶ï¼šæ˜¯è‡ªå·±çš„è¯„è®º ä¸” åœ¨30åˆ†é’Ÿå†…
                                    const canDelete = isMyComment && withinTimeLimit;
                                    
                                    // è¯¦ç»†è°ƒè¯•ä¿¡æ¯ï¼ˆæ‰€æœ‰è¯„è®ºéƒ½è¾“å‡ºï¼‰
                                    const debugInfo = {
                                        myDeviceId: myDeviceId,
                                        commentDeviceId: comment.device_id || '(null)',
                                        commentDeviceIdType: typeof comment.device_id,
                                        commentDeviceIdValue: comment.device_id,
                                        hasDeviceId: !!comment.device_id,
                                        isMyComment: isMyComment,
                                        withinTimeLimit: withinTimeLimit,
                                        canDelete: canDelete,
                                        timeAgo: getTimeAgo(comment.timestamp),
                                        timestamp: comment.timestamp,
                                        now: Date.now(),
                                        timeDiff: Date.now() - comment.timestamp,
                                        thirtyMinutes: 30 * 60 * 1000
                                    };
                                    
                                    // å¦‚æœdevice_idä¸ºnullï¼Œç»™å‡ºæ˜ç¡®æç¤º
                                    if (!comment.device_id) {
                                        console.warn(`âš ï¸ è¯„è®º ${comment.id} æ²¡æœ‰ device_idï¼`, {
                                            ...debugInfo,
                                            reason: 'è¿™å¯èƒ½æ˜¯æ—§è¯„è®ºï¼ˆåœ¨æ·»åŠ åˆ é™¤åŠŸèƒ½ä¹‹å‰å‘å¸ƒçš„ï¼‰ï¼Œæˆ–è€…ä¿å­˜æ—¶å‡ºé”™'
                                        });
                                    } else {
                                        console.log(`è¯„è®º ${comment.id} è¯¦æƒ…:`, debugInfo);
                                    }
                                    
                                    // è°ƒè¯•ï¼šå¦‚æœæ²¡æœ‰device_idï¼Œæ˜¾ç¤ºæç¤º
                                    const debugText = !comment.device_id ? ' (æ—§è¯„è®ºï¼Œæ— device_id)' : '';
                                    
                                    return `
                                        <div class="comment-item" id="comment-${comment.id}">
                                            <div class="comment-avatar">${getAvatar(comment.device_id || comment.id)}</div>
                                            <div class="comment-content" style="flex: 1;">
                                                <div class="comment-author" style="font-size: 11px; color: #999; margin-bottom: 2px;">
                                                    ${comment.device_id ? getAnonymousName(comment.device_id) : 'åŒ¿åç”¨æˆ·'}
                                                </div>
                                                ${escapeHtml(comment.content)}
                                                <div class="comment-time">
                                                    ${getTimeAgo(comment.timestamp)}${debugText}
                                                    ${canDelete ? ' Â· <span style="color: #ff9800;">å¯åˆ é™¤</span>' : ''}
                                                    ${isMyComment && !withinTimeLimit ? ' Â· <span style="color: #999;">å·²è¶…è¿‡30åˆ†é’Ÿ</span>' : ''}
                                                    ${comment.device_id && !isMyComment ? ' Â· <span style="color: #999;">(ä»–äººè¯„è®º)</span>' : ''}
                                                </div>
                                            </div>
                                            ${canDelete ? `
                                                <button class="comment-delete-btn" onclick="deleteComment(${comment.id}, ${post.id})" title="åˆ é™¤è¯„è®ºï¼ˆ30åˆ†é’Ÿå†…ï¼‰">
                                                    ğŸ—‘ï¸
                                                </button>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : ''}
                        <div class="comment-input-box" id="comment-input-${post.id}" style="display: none;">
                            <input type="text" class="comment-input" id="comment-text-${post.id}" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." maxlength="200" onkeypress="if(event.key==='Enter') submitComment(${post.id})">
                            <button class="comment-btn" onclick="submitComment(${post.id})">å‘é€</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            document.getElementById('total-posts').innerText = posts.length;
            const totalLikes = posts.reduce((sum, post) => sum + post.likes, 0);
            document.getElementById('total-likes').innerText = totalLikes;
        }

        // æ‰“å¼€å‘å¸ƒå¼¹çª—
        function openModal() {
            document.getElementById('post-modal').classList.add('active');
            document.getElementById('post-content').value = '';
            updateCharCount();
        }

        // å…³é—­å¼¹çª—
        function closeModal() {
            document.getElementById('post-modal').classList.remove('active');
        }

        // æ›´æ–°å­—æ•°ç»Ÿè®¡
        function updateCharCount() {
            const content = document.getElementById('post-content').value;
            document.getElementById('char-count').innerText = content.length;
        }

        // æäº¤å¸–å­
        function submitPost() {
            const content = document.getElementById('post-content').value.trim();
            
            if (!content) {
                showToast('è¯·è¾“å…¥å†…å®¹');
                return;
            }

            if (content.length < 5) {
                showToast('å†…å®¹å¤ªçŸ­å•¦ï¼Œè‡³å°‘5ä¸ªå­—');
                return;
            }

            const deviceId = getDeviceId();
            console.log('ğŸ“¤ æäº¤å¸–å­:', { 
                content: content.substring(0, 30), 
                deviceId: deviceId,
                deviceIdType: typeof deviceId
            });
            
            if (!deviceId) {
                console.error('âŒ è®¾å¤‡IDä¸ºç©ºï¼æ— æ³•æäº¤å¸–å­');
                showToast('âŒ è®¾å¤‡IDè·å–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }

            fetch('/api/forum/post', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content, deviceId })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast('âœ… å‘å¸ƒæˆåŠŸï¼');
                    closeModal();
                    loadPosts();
                } else {
                    showToast('å‘å¸ƒå¤±è´¥');
                }
            })
            .catch(err => {
                showToast('ç½‘ç»œé”™è¯¯');
                console.error(err);
            });
        }

        // ç‚¹èµ/å–æ¶ˆç‚¹èµ
        function toggleLike(postId, event) {
            const isLiked = myLikes.includes(postId);
            const action = isLiked ? 'unlike' : 'like';

            // ç«‹å³æ›´æ–°UIï¼ˆä¹è§‚æ›´æ–°ï¼‰
            const post = posts.find(p => p.id === postId);
            if (post) {
                // ç«‹å³æ›´æ–°æœ¬åœ°æ•°æ®
                if (action === 'like') {
                    myLikes.push(postId);
                    post.likes += 1;
                } else {
                    myLikes = myLikes.filter(id => id !== postId);
                    post.likes = Math.max(0, post.likes - 1);
                }
                localStorage.setItem('forum_likes', JSON.stringify(myLikes));
                
                // ç«‹å³æ›´æ–°UI
                const likeCountEl = document.getElementById('like-count-' + postId);
                if (likeCountEl) {
                    likeCountEl.innerText = post.likes;
                }
                
                if (event && event.currentTarget) {
                    const actionEl = event.currentTarget;
                    if (action === 'like') {
                        actionEl.classList.add('liked');
                        actionEl.querySelector('span:first-child').innerText = 'â¤ï¸';
                    } else {
                        actionEl.classList.remove('liked');
                        actionEl.querySelector('span:first-child').innerText = 'ğŸ¤';
                    }
                }
                updateStats();
                showToast(action === 'like' ? 'âœ… å·²ç‚¹èµ' : 'å·²å–æ¶ˆç‚¹èµ');
            }

            // å‘é€åˆ°æœåŠ¡å™¨ï¼ˆåå°åŒæ­¥ï¼‰
            fetch('/api/forum/like', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ postId, action })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // ç”¨æœåŠ¡å™¨è¿”å›çš„çœŸå®æ•°æ®æ›´æ–°
                    if (post) {
                        post.likes = data.likes;
                        const likeCountEl = document.getElementById('like-count-' + postId);
                        if (likeCountEl) {
                            likeCountEl.innerText = data.likes;
                        }
                        updateStats();
                    }
                } else {
                    // å¤±è´¥æ—¶å›æ»š
                    if (action === 'like') {
                        myLikes = myLikes.filter(id => id !== postId);
                    } else {
                        myLikes.push(postId);
                    }
                    localStorage.setItem('forum_likes', JSON.stringify(myLikes));
                    renderPosts(); // é‡æ–°æ¸²æŸ“
                    showToast('æ“ä½œå¤±è´¥');
                }
            })
            .catch(err => {
                // ç½‘ç»œé”™è¯¯æ—¶å›æ»š
                if (action === 'like') {
                    myLikes = myLikes.filter(id => id !== postId);
                } else {
                    myLikes.push(postId);
                }
                localStorage.setItem('forum_likes', JSON.stringify(myLikes));
                renderPosts();
                showToast('ç½‘ç»œé”™è¯¯');
                console.error(err);
            });
        }

        // è·å–å¤´åƒè¡¨æƒ…ï¼ˆåŸºäºdevice_idï¼Œç¡®ä¿åŒä¸€ç”¨æˆ·å¤´åƒä¸€è‡´ï¼‰
        function getAvatar(deviceId) {
            if (!deviceId) {
                const avatars = ['ğŸ˜Š', 'ğŸ˜', 'ğŸ¤“', 'ğŸ˜‡', 'ğŸ¥³', 'ğŸ¤©', 'ğŸ˜º', 'ğŸ¦Š', 'ğŸ¼', 'ğŸ¨'];
                return avatars[0]; // é»˜è®¤å¤´åƒ
            }
            
            const avatars = ['ğŸ˜Š', 'ğŸ˜', 'ğŸ¤“', 'ğŸ˜‡', 'ğŸ¥³', 'ğŸ¤©', 'ğŸ˜º', 'ğŸ¦Š', 'ğŸ¼', 'ğŸ¨', 'ğŸ»', 'ğŸ°', 'ğŸ±', 'ğŸ¶', 'ğŸ¹', 'ğŸ­'];
            
            // ä½¿ç”¨device_idç”Ÿæˆå›ºå®šçš„ç´¢å¼•
            let hash = 0;
            for (let i = 0; i < deviceId.length; i++) {
                const char = deviceId.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            
            return avatars[Math.abs(hash) % avatars.length];
        }

        // è·å–ç›¸å¯¹æ—¶é—´
        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) return days + 'å¤©å‰';
            if (hours > 0) return hours + 'å°æ—¶å‰';
            if (minutes > 0) return minutes + 'åˆ†é’Ÿå‰';
            return 'åˆšåˆš';
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        // æ˜¾ç¤ºæç¤º
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.innerText = message;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 2000);
        }

        // æ¸²æŸ“åˆ†é¡µ
        function renderPagination() {
            const paginationEl = document.getElementById('pagination');
            if (!paginationEl) return;
            
            if (totalPages <= 1) {
                paginationEl.innerHTML = '';
                return;
            }
            
            paginationEl.innerHTML = `
                <button class="page-btn" onclick="loadPosts(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    ä¸Šä¸€é¡µ
                </button>
                <span class="page-info">ç¬¬ ${currentPage} / ${totalPages} é¡µ</span>
                <button class="page-btn" onclick="loadPosts(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    ä¸‹ä¸€é¡µ
                </button>
            `;
        }

        // åˆ‡æ¢è¯„è®ºè¾“å…¥æ¡†
        function toggleCommentInput(postId) {
            const inputBox = document.getElementById(`comment-input-${postId}`);
            const commentsSection = document.getElementById(`comments-${postId}`);
            
            if (inputBox) {
                const isVisible = inputBox.style.display !== 'none';
                inputBox.style.display = isVisible ? 'none' : 'flex';
                
                // å¦‚æœè¯„è®ºåŒºåŸŸéšè—ï¼Œä¹Ÿæ˜¾ç¤ºå‡ºæ¥
                if (commentsSection && !isVisible) {
                    commentsSection.style.display = commentsSection.style.display === 'none' ? 'block' : 'block';
                }
                
                if (!isVisible) {
                    const input = document.getElementById(`comment-text-${postId}`);
                    if (input) {
                        setTimeout(() => input.focus(), 100);
                    }
                }
            }
        }

        // åˆ¤æ–­æ˜¯å¦å¯ä»¥åˆ é™¤è¯„è®ºï¼ˆ30åˆ†é’Ÿå†…ï¼‰
        function canDeleteComment(timestamp) {
            const now = Date.now();
            const commentTime = timestamp;
            const timeDiff = now - commentTime;
            const thirtyMinutes = 30 * 60 * 1000; // 30åˆ†é’Ÿï¼ˆæ¯«ç§’ï¼‰
            return timeDiff <= thirtyMinutes;
        }

        // æäº¤è¯„è®º
        function submitComment(postId) {
            const input = document.getElementById(`comment-text-${postId}`);
            if (!input) return;
            
            const content = input.value.trim();
            if (!content || content.length < 2) {
                showToast('è¯„è®ºè‡³å°‘2ä¸ªå­—');
                return;
            }
            
            if (content.length > 200) {
                showToast('è¯„è®ºæœ€å¤š200å­—');
                return;
            }
            
            // ç¦ç”¨è¾“å…¥æ¡†å’ŒæŒ‰é’®
            input.disabled = true;
            const btn = input.nextElementSibling;
            if (btn) btn.disabled = true;
            
            const deviceId = getDeviceId();
            console.log('ğŸ“¤ æäº¤è¯„è®º:', { 
                postId, 
                content: content.substring(0, 20), 
                deviceId: deviceId,
                deviceIdType: typeof deviceId,
                deviceIdLength: deviceId ? deviceId.length : 0
            });
            
            if (!deviceId) {
                console.error('âŒ è®¾å¤‡IDä¸ºç©ºï¼æ— æ³•æäº¤è¯„è®º');
                showToast('âŒ è®¾å¤‡IDè·å–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                input.disabled = false;
                if (btn) btn.disabled = false;
                return;
            }
            
            const requestBody = { postId, content, deviceId };
            console.log('ğŸ“¤ è¯·æ±‚ä½“:', requestBody);
            
            fetch('/api/forum/comment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            })
            .then(res => {
                console.log('ğŸ“¥ æœåŠ¡å™¨å“åº”çŠ¶æ€:', res.status);
                if (!res.ok) {
                    return res.json().then(err => {
                        console.error('âŒ æœåŠ¡å™¨é”™è¯¯:', err);
                        throw new Error(err.error || 'è¯·æ±‚å¤±è´¥');
                    });
                }
                return res.json();
            })
            .then(data => {
                if (data.success) {
                    input.value = '';
                    showToast('âœ… è¯„è®ºæˆåŠŸï¼');
                    console.log('âœ… è¯„è®ºå‘å¸ƒæˆåŠŸï¼ŒID:', data.id, 'è®¾å¤‡ID:', deviceId);
                    // éšè—è¾“å…¥æ¡†
                    const inputBox = document.getElementById(`comment-input-${postId}`);
                    if (inputBox) inputBox.style.display = 'none';
                    // é‡æ–°åŠ è½½å½“å‰é¡µ
                    setTimeout(() => {
                        loadPosts(currentPage);
                        // åŠ è½½åæ£€æŸ¥æ–°è¯„è®ºæ˜¯å¦æœ‰åˆ é™¤æŒ‰é’®
                        setTimeout(() => {
                            const newComment = document.getElementById(`comment-${data.id}`);
                            if (newComment) {
                                const deleteBtn = newComment.querySelector('.comment-delete-btn');
                                if (deleteBtn) {
                                    console.log('âœ… æ–°è¯„è®ºå·²æ˜¾ç¤ºåˆ é™¤æŒ‰é’®ï¼');
                                    showToast('âœ… æ–°è¯„è®ºå·²æ˜¾ç¤ºåˆ é™¤æŒ‰é’®ï¼Œå¯ä»¥åˆ é™¤ï¼');
                                } else {
                                    console.warn('âš ï¸ æ–°è¯„è®ºæ²¡æœ‰åˆ é™¤æŒ‰é’®ï¼è¯·æ£€æŸ¥æ§åˆ¶å°è°ƒè¯•ä¿¡æ¯');
                                    showToast('âš ï¸ æ–°è¯„è®ºæ²¡æœ‰åˆ é™¤æŒ‰é’®ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°');
                                }
                            }
                        }, 500);
                    }, 300);
                } else {
                    showToast('è¯„è®ºå¤±è´¥');
                    input.disabled = false;
                    if (btn) btn.disabled = false;
                }
            })
            .catch(err => {
                console.error('âŒ æäº¤è¯„è®ºå¤±è´¥:', err);
                showToast(err.message || 'ç½‘ç»œé”™è¯¯');
                input.disabled = false;
                if (btn) btn.disabled = false;
            });
        }

        // åˆ é™¤è¯„è®º
        function deleteComment(commentId, postId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ\nï¼ˆè¯„è®ºè¶…è¿‡30åˆ†é’Ÿåå°†æ— æ³•åˆ é™¤ï¼‰')) {
                return;
            }
            
            const deviceId = getDeviceId();
            
            fetch(`/api/forum/comment/${commentId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ deviceId })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast('âœ… è¯„è®ºå·²åˆ é™¤');
                    // é‡æ–°åŠ è½½å½“å‰é¡µ
                    loadPosts(currentPage);
                } else {
                    showToast(data.error || 'åˆ é™¤å¤±è´¥');
                }
            })
            .catch(err => {
                showToast('ç½‘ç»œé”™è¯¯');
                console.error(err);
            });
        }

        // åˆ é™¤å¸–å­
        function deletePost(postId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¸–å­å—ï¼Ÿ\nï¼ˆå¸–å­è¶…è¿‡30åˆ†é’Ÿåå°†æ— æ³•åˆ é™¤ï¼Œåˆ é™¤åä¼šåŒæ—¶åˆ é™¤æ‰€æœ‰è¯„è®ºï¼‰')) {
                return;
            }
            
            const deviceId = getDeviceId();
            
            fetch(`/api/forum/post/${postId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ deviceId })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast('âœ… å¸–å­å·²åˆ é™¤ï¼ˆæ‰€æœ‰è¯„è®ºä¹Ÿå·²åˆ é™¤ï¼‰');
                    // é‡æ–°åŠ è½½å½“å‰é¡µ
                    loadPosts(currentPage);
                } else {
                    showToast(data.error || 'åˆ é™¤å¤±è´¥');
                }
            })
            .catch(err => {
                showToast('ç½‘ç»œé”™è¯¯');
                console.error(err);
            });
        }

        // é¡µé¢åŠ è½½
        loadPosts();
    </script>
</body>
</html>



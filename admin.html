<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, "Microsoft YaHei", sans-serif; }
        body { background-color: #f0f2f5; min-height: 100vh; }

        /* é¡¶éƒ¨å¯¼èˆª */
        header { 
            background: linear-gradient(135deg, #0f6b48 0%, #1a8d5f 100%);
            color: #fff; 
            padding: 15px 30px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { font-size: 20px; font-weight: bold; }
        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .btn-header {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: 0.3s;
        }
        .btn-header:hover {
            background: rgba(255,255,255,0.3);
        }

        /* ä¸»å®¹å™¨ */
        .container { max-width: 1400px; margin: 20px auto; padding: 0 20px; }

        /* å¡ç‰‡ */
        .card { 
            background: #fff; 
            border-radius: 8px; 
            padding: 25px; 
            margin-bottom: 20px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .card-title { 
            font-size: 18px; 
            color: #0f6b48; 
            border-bottom: 2px solid #f0f2f5; 
            padding-bottom: 10px; 
            margin-bottom: 20px; 
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* é…ç½®è¡¨å• */
        .form-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }
        .form-label {
            font-weight: bold;
            color: #666;
        }
        .form-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }
        .form-input:focus {
            outline: none;
            border-color: #0f6b48;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        thead {
            background: #f8f9fa;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        th {
            font-weight: 600;
            color: #495057;
            font-size: 13px;
            text-transform: uppercase;
        }
        td {
            font-size: 14px;
            color: #212529;
        }
        tbody tr:hover {
            background: #f8f9fa;
        }
        .table-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        .table-input:focus {
            outline: none;
            border-color: #0f6b48;
        }
        .table-input-small {
            width: 60px;
        }

        /* æŒ‰é’® */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: 0.3s;
        }
        .btn-primary {
            background: #0f6b48;
            color: white;
        }
        .btn-primary:hover {
            background: #0b5539;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #218838;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }

        /* å›¾ç‰‡é¢„è§ˆ */
        .img-preview {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
        }

        /* æç¤ºä¿¡æ¯ */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 4px;
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }
        .toast.success {
            background: #28a745;
        }
        .toast.error {
            background: #dc3545;
        }

        /* æ“ä½œæŒ‰é’®åˆ— */
        .action-btns {
            display: flex;
            gap: 5px;
        }

        /* æ‰¹é‡å¯¼å…¥/å¯¼å‡º */
        .bulk-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        /* æ–‡ä»¶ä¸Šä¼  */
        .file-input {
            display: none;
        }

        /* å¸®åŠ©æç¤º */
        .help-text {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        /* ===== å“åº”å¼è®¾è®¡ - æ‰‹æœºç«¯é€‚é… ===== */
        @media (max-width: 768px) {
            body {
                overflow-x: hidden;
            }
            
            /* é¡¶éƒ¨å¯¼èˆª */
            header {
                flex-direction: column;
                gap: 10px;
                padding: 12px 15px;
            }
            
            h1 {
                font-size: 18px;
            }
            
            .header-actions {
                width: 100%;
                flex-wrap: wrap;
                justify-content: flex-start;
            }
            
            .btn-header {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            /* å®¹å™¨ */
            .container {
                padding: 0 15px;
            }
            
            /* å¡ç‰‡ */
            .card {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .card-title {
                font-size: 16px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            /* è¡¨å• */
            .form-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .form-label {
                font-size: 13px;
            }
            
            .form-input {
                font-size: 13px;
            }
            
            /* æ‰¹é‡æ“ä½œæŒ‰é’® */
            .bulk-actions {
                flex-wrap: wrap;
                width: 100%;
                margin-top: 10px;
            }
            
            .bulk-actions .btn {
                flex: 1;
                min-width: 120px;
            }
            
            /* è¡¨æ ¼å®¹å™¨ */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
                font-size: 12px;
            }
            
            th, td {
                padding: 8px 6px;
                font-size: 12px;
            }
            
            th {
                font-size: 11px;
            }
            
            .table-input {
                padding: 4px 6px;
                font-size: 12px;
            }
            
            .img-preview {
                width: 40px;
                height: 40px;
            }
            
            /* æŒ‰é’® */
            .btn {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .action-btns {
                flex-direction: column;
                gap: 3px;
            }
            
            /* æç¤ºæ¡† */
            .toast {
                right: 10px;
                left: 10px;
                padding: 12px 15px;
                font-size: 13px;
            }
        }
        
        /* è¶…å°å±å¹• */
        @media (max-width: 480px) {
            h1 {
                font-size: 16px;
            }
            
            .card {
                padding: 12px;
            }
            
            .card-title {
                font-size: 15px;
            }
            
            table {
                min-width: 500px;
                font-size: 11px;
            }
            
            th, td {
                padding: 6px 4px;
            }
            
            .bulk-actions .btn {
                width: 100%;
            }
            
            .btn-header {
                font-size: 11px;
                padding: 5px 10px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>ğŸ½ï¸ é¤å…çœ‹æ¿åå°ç®¡ç†ç³»ç»Ÿ</h1>
        <div class="header-actions">
            <button class="btn-header" onclick="exportAllData()">ğŸ“¥ å¯¼å‡ºæ‰€æœ‰æ•°æ®</button>
            <button class="btn-header" onclick="resetToken()">ğŸ”‘ é‡ç½®å¯†é’¥</button>
            <a href="/" target="_blank" class="btn-header" style="text-decoration: none;">æŸ¥çœ‹å‰å° â†’</a>
        </div>
    </header>

    <div class="container">
        <!-- å…¨å±€é…ç½® -->
        <div class="card">
            <div class="card-title">âš™ï¸ å…¨å±€é…ç½®</div>
            
            <div class="form-row">
                <label class="form-label">é¡µé¢æ ‡é¢˜</label>
                <input type="text" class="form-input" id="config-title" placeholder="ä¾‹å¦‚ï¼šåŸƒåŠå°¼ç½—æ²³é¤å…å…¨æ¥è§¦">
            </div>
            
            <div class="form-row">
                <label class="form-label">æ—¥æœŸ/ä½ç½®</label>
                <div style="flex: 1;">
                    <input type="text" class="form-input" id="config-date" placeholder="ä¾‹å¦‚ï¼š2025-12-08 åˆé¤">
                    <div class="checkbox-group" style="margin-top: 8px;">
                        <input type="checkbox" id="config-auto-date">
                        <label for="config-auto-date">è‡ªåŠ¨ç”Ÿæˆå½“å‰æ—¥æœŸ</label>
                    </div>
                    <div class="help-text">å‹¾é€‰åå°†è‡ªåŠ¨æ˜¾ç¤ºå½“å‰æ—¥æœŸå’Œæ—¶é—´æ®µï¼ˆåˆé¤/æ™šé¤ï¼‰</div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
        </div>

        <!-- èœå“ç®¡ç† -->
        <div class="card">
            <div class="card-title">
                <span>ğŸ½ï¸ èœå“ç®¡ç†</span>
                <div class="bulk-actions">
                    <button class="btn btn-success" onclick="addDish()">â• æ–°å¢èœå“</button>
                    <button class="btn btn-secondary" onclick="importDishes()">ğŸ“¤ æ‰¹é‡å¯¼å…¥</button>
                    <button class="btn" style="background:#17a2b8; color:white;" onclick="openSmartImport()">ğŸ“‹ æ™ºèƒ½å¯¼å…¥èœå•</button>
                    <button class="btn btn-secondary" onclick="exportDishes()">ğŸ“¥ å¯¼å‡ºè¡¨æ ¼</button>
                </div>
            </div>
            
            <div class="table-container">
                <table id="dishes-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">ID</th>
                            <th>èœå“åç§°</th>
                            <th>å¨å¸ˆ</th>
                            <th style="width: 80px;">ç‚¹èµæ•°</th>
                            <th style="width: 80px;">è¸©æ•°</th>
                            <th style="width: 120px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="dishes-tbody">
                        <tr><td colspan="6" style="text-align: center; color: #999;">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- å¨å¸ˆç®¡ç† -->
        <div class="card">
            <div class="card-title">
                <span>ğŸ‘¨â€ğŸ³ å¨å¸ˆç®¡ç†</span>
                <div class="bulk-actions">
                    <button class="btn btn-success" onclick="addChef()">â• æ–°å¢å¨å¸ˆ</button>
                    <button class="btn btn-secondary" onclick="importChefs()">ğŸ“¤ æ‰¹é‡å¯¼å…¥</button>
                    <button class="btn btn-secondary" onclick="exportChefs()">ğŸ“¥ å¯¼å‡ºè¡¨æ ¼</button>
                </div>
            </div>
            
            <div class="table-container">
                <table id="chefs-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">ID</th>
                            <th style="width: 60px;">ç…§ç‰‡</th>
                            <th>å§“å</th>
                            <th>èŒä½</th>
                            <th>ç®€ä»‹</th>
                            <th style="width: 70px;">æ—¥æ¦œ</th>
                            <th style="width: 70px;">æœˆæ¦œ</th>
                            <th style="width: 70px;">æœˆç¥¨</th>
                            <th style="width: 120px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="chefs-tbody">
                        <tr><td colspan="9" style="text-align: center; color: #999;">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>
        <div id="smart-import-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
        <div style="background:white; width:90%; max-width:800px; max-height:90vh; border-radius:8px; display:flex; flex-direction:column; overflow:hidden;">
            <div style="padding:15px 20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;">ğŸ“‹ æ™ºèƒ½èœå•è¯†åˆ«</h3>
                <span onclick="document.getElementById('smart-import-modal').style.display='none'" style="cursor:pointer; font-size:24px;">&times;</span>
            </div>
            <div style="padding:20px; overflow-y:auto; flex:1;">
                <div style="background:#fff3cd; color:#856404; padding:10px; border-radius:4px; margin-bottom:15px; font-size:13px;">
                    ğŸ’¡ æç¤ºï¼šç›´æ¥ç²˜è´´å¾®ä¿¡ç¾¤é‡Œçš„èœå•é€šçŸ¥ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«èœå“å’Œå¯¹åº”å¨å¸ˆã€‚
                </div>
                <textarea id="import-text" style="width:100%; height:150px; padding:10px; border:1px solid #ddd; border-radius:4px; margin-bottom:15px;" placeholder="è¯·ç²˜è´´èœå•æ–‡æœ¬..."></textarea>
                <button class="btn btn-primary" onclick="parseMenuText()" style="width:100%;">ğŸ” å¼€å§‹è§£æ</button>
                
                <div id="import-preview" style="display:none; margin-top:20px; border-top:1px solid #eee; padding-top:20px;">
                    <div style="margin-bottom:10px; font-weight:bold; color:#0f6b48;">é¢„è§ˆå¯¼å…¥ç»“æœ (<span id="preview-count">0</span> é“èœ)</div>
                    <div style="max-height:300px; overflow-y:auto; border:1px solid #eee; border-radius:4px;">
                        <table style="width:100%; border-collapse:collapse;">
                            <thead style="background:#f8f9fa; position:sticky; top:0;">
                                <tr>
                                    <th style="padding:8px; text-align:left;">èœå“åç§°</th>
                                    <th style="padding:8px; text-align:left;">å½’å±å¨å¸ˆ</th>
                                    <th style="padding:8px; text-align:center; width:60px;">çŠ¶æ€</th>
                                </tr>
                            </thead>
                            <tbody id="preview-tbody"></tbody>
                        </table>
                    </div>
                    <div style="margin-top:15px; text-align:right;">
                        <button class="btn btn-secondary" onclick="document.getElementById('smart-import-modal').style.display='none'">å–æ¶ˆ</button>
                        <button class="btn btn-success" onclick="executeImport()">âœ… ç¡®è®¤å¹¶å¯¼å…¥</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼ è¾“å…¥ -->
    <input type="file" id="file-input-dishes" class="file-input" accept=".json,.csv" onchange="handleDishesImport(event)">
    <input type="file" id="file-input-chefs" class="file-input" accept=".json,.csv" onchange="handleChefsImport(event)">
    <input type="file" id="file-input-photo" class="file-input" accept="image/*">

    <script>
        let adminToken = localStorage.getItem('admin_token') || '';
        let currentPhotoTarget = null;

        // è·å–è¯·æ±‚å¤´
        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'x-admin-token': adminToken
            };
        }

        // åˆå§‹åŒ–
        function init() {
            if (!adminToken) {
                promptForToken();
                return;
            }
            loadAll();
        }

        // æç¤ºè¾“å…¥å¯†é’¥
        function promptForToken() {
            const token = prompt('è¯·è¾“å…¥ç®¡ç†å¯†é’¥ï¼ˆé»˜è®¤: demo2024ï¼‰ï¼š', 'demo2024');
            if (token) {
                adminToken = token;
                localStorage.setItem('admin_token', token);
                loadAll();
            } else {
                showToast('éœ€è¦è®¿é—®å¯†é’¥æ‰èƒ½ä½¿ç”¨åå°ç®¡ç†', 'error');
            }
        }

        // åŠ è½½æ‰€æœ‰æ•°æ®
        async function loadAll() {
            try {
                await loadConfig();
                await loadDishes();
                await loadChefs();
            } catch (err) {
                console.error('åŠ è½½å¤±è´¥:', err);
                showToast('åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
            }
        }

        // åŠ è½½é…ç½®
        async function loadConfig() {
            try {
                const res = await fetch('/api/admin/config', { headers: getHeaders() });
                if (!res.ok) throw new Error('è·å–é…ç½®å¤±è´¥');
                const data = await res.json();
                
                document.getElementById('config-title').value = data.config.title || '';
                document.getElementById('config-date').value = data.config.date_location || '';
                document.getElementById('config-auto-date').checked = data.config.auto_date === 1;
            } catch (err) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', err);
            }
        }

        // ä¿å­˜é…ç½®
        async function saveConfig() {
            const config = {
                title: document.getElementById('config-title').value,
                date_location: document.getElementById('config-date').value,
                auto_date: document.getElementById('config-auto-date').checked
            };

            try {
                const res = await fetch('/api/admin/config', {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(config)
                });

                if (!res.ok) throw new Error('ä¿å­˜å¤±è´¥');
                showToast('âœ… é…ç½®å·²ä¿å­˜', 'success');
            } catch (err) {
                showToast('ä¿å­˜å¤±è´¥: ' + err.message, 'error');
            }
        }

        // åŠ è½½èœå“
        async function loadDishes() {
            try {
                const res = await fetch('/api/admin/dishes', { headers: getHeaders() });
                if (!res.ok) throw new Error('è·å–èœå“å¤±è´¥');
                const data = await res.json();
                
                renderDishes(data.dishes);
            } catch (err) {
                console.error('åŠ è½½èœå“å¤±è´¥:', err);
                document.getElementById('dishes-tbody').innerHTML = 
                    '<tr><td colspan="6" style="text-align: center; color: red;">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        // æ¸²æŸ“èœå“è¡¨æ ¼
        function renderDishes(dishes) {
            const tbody = document.getElementById('dishes-tbody');
            
            if (dishes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">æš‚æ— èœå“</td></tr>';
                return;
            }

            tbody.innerHTML = dishes.map(dish => `
                <tr data-id="${dish.id}">
                    <td>${dish.id}</td>
                    <td><input type="text" class="table-input" value="${dish.name}" onchange="updateDish(${dish.id}, 'name', this.value)"></td>
                    <td><input type="text" class="table-input" value="${dish.chef}" onchange="updateDish(${dish.id}, 'chef', this.value)"></td>
                    <td><input type="number" class="table-input table-input-small" value="${dish.up_votes}" onchange="updateDish(${dish.id}, 'up_votes', this.value)"></td>
                    <td><input type="number" class="table-input table-input-small" value="${dish.down_votes}" onchange="updateDish(${dish.id}, 'down_votes', this.value)"></td>
                    <td class="action-btns">
                        <button class="btn btn-danger" onclick="deleteDish(${dish.id})">åˆ é™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        // æ›´æ–°èœå“
        async function updateDish(id, field, value) {
            const row = document.querySelector(`#dishes-tbody tr[data-id="${id}"]`);
            const data = {
                name: row.querySelector('input[type="text"]').value,
                chef: row.querySelectorAll('input[type="text"]')[1].value,
                up_votes: parseInt(row.querySelectorAll('input[type="number"]')[0].value) || 0,
                down_votes: parseInt(row.querySelectorAll('input[type="number"]')[1].value) || 0
            };

            try {
                const res = await fetch(`/api/admin/dishes/${id}`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify(data)
                });

                if (!res.ok) throw new Error('æ›´æ–°å¤±è´¥');
                showToast('âœ… å·²æ›´æ–°', 'success');
            } catch (err) {
                showToast('æ›´æ–°å¤±è´¥: ' + err.message, 'error');
            }
        }

        // æ·»åŠ èœå“
        async function addDish() {
            const data = {
                name: 'æ–°èœå“',
                chef: 'æ–°å¨å¸ˆ',
                up_votes: 0,
                down_votes: 0
            };

            try {
                const res = await fetch('/api/admin/dishes', {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(data)
                });

                if (!res.ok) throw new Error('åˆ›å»ºå¤±è´¥');
                showToast('âœ… å·²æ·»åŠ æ–°èœå“', 'success');
                await loadDishes();
            } catch (err) {
                showToast('æ·»åŠ å¤±è´¥: ' + err.message, 'error');
            }
        }

        // åˆ é™¤èœå“
        async function deleteDish(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™é“èœå“å—ï¼Ÿ')) return;

            try {
                const res = await fetch(`/api/admin/dishes/${id}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });

                if (!res.ok) throw new Error('åˆ é™¤å¤±è´¥');
                showToast('âœ… å·²åˆ é™¤', 'success');
                await loadDishes();
            } catch (err) {
                showToast('åˆ é™¤å¤±è´¥: ' + err.message, 'error');
            }
        }

        // åŠ è½½å¨å¸ˆ
        async function loadChefs() {
            try {
                const res = await fetch('/api/admin/chefs', { headers: getHeaders() });
                if (!res.ok) throw new Error('è·å–å¨å¸ˆå¤±è´¥');
                const data = await res.json();
                
                renderChefs(data.chefs);
            } catch (err) {
                console.error('åŠ è½½å¨å¸ˆå¤±è´¥:', err);
                document.getElementById('chefs-tbody').innerHTML = 
                    '<tr><td colspan="9" style="text-align: center; color: red;">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        // æ¸²æŸ“å¨å¸ˆè¡¨æ ¼
        function renderChefs(chefs) {
            const tbody = document.getElementById('chefs-tbody');
            
            if (chefs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #999;">æš‚æ— å¨å¸ˆ</td></tr>';
                return;
            }

            tbody.innerHTML = chefs.map(chef => `
                <tr data-id="${chef.id}">
                    <td>${chef.id}</td>
                    <td>
                        <img src="${chef.photo}" class="img-preview" onclick="changePhoto(${chef.id})" title="ç‚¹å‡»æ›´æ¢ç…§ç‰‡">
                    </td>
                    <td><input type="text" class="table-input" value="${chef.name}" onchange="updateChef(${chef.id})"></td>
                    <td><input type="text" class="table-input" value="${chef.role}" onchange="updateChef(${chef.id})"></td>
                    <td><input type="text" class="table-input" value="${chef.description || ''}" onchange="updateChef(${chef.id})"></td>
                    <td><input type="number" class="table-input table-input-small" value="${chef.daily_rank}" onchange="updateChef(${chef.id})"></td>
                    <td><input type="number" class="table-input table-input-small" value="${chef.monthly_rank}" onchange="updateChef(${chef.id})"></td>
                    <td><input type="number" class="table-input table-input-small" value="${chef.monthly_votes}" onchange="updateChef(${chef.id})"></td>
                    <td class="action-btns">
                        <button class="btn btn-danger" onclick="deleteChef(${chef.id})">åˆ é™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        // æ›´æ–°å¨å¸ˆ
        async function updateChef(id) {
            const row = document.querySelector(`#chefs-tbody tr[data-id="${id}"]`);
            const inputs = row.querySelectorAll('input');
            const data = {
                name: inputs[0].value,
                role: inputs[1].value,
                description: inputs[2].value,
                daily_rank: parseInt(inputs[3].value) || 99,
                monthly_rank: parseInt(inputs[4].value) || 99,
                monthly_votes: parseInt(inputs[5].value) || 0,
                photo: row.querySelector('img').src
            };

            try {
                const res = await fetch(`/api/admin/chefs/${id}`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify(data)
                });

                if (!res.ok) throw new Error('æ›´æ–°å¤±è´¥');
                showToast('âœ… å·²æ›´æ–°', 'success');
            } catch (err) {
                showToast('æ›´æ–°å¤±è´¥: ' + err.message, 'error');
            }
        }

        // æ·»åŠ å¨å¸ˆ
        async function addChef() {
            const data = {
                name: 'æ–°å¨å¸ˆ',
                role: 'å¨å¸ˆ',
                photo: 'static/logo.png',
                description: 'è¯·ä¿®æ”¹ç®€ä»‹',
                daily_rank: 99,
                monthly_rank: 99,
                monthly_votes: 0
            };

            try {
                const res = await fetch('/api/admin/chefs', {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(data)
                });

                if (!res.ok) throw new Error('åˆ›å»ºå¤±è´¥');
                showToast('âœ… å·²æ·»åŠ æ–°å¨å¸ˆ', 'success');
                await loadChefs();
            } catch (err) {
                showToast('æ·»åŠ å¤±è´¥: ' + err.message, 'error');
            }
        }

        // åˆ é™¤å¨å¸ˆ
        async function deleteChef(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä½å¨å¸ˆå—ï¼Ÿ')) return;

            try {
                const res = await fetch(`/api/admin/chefs/${id}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });

                if (!res.ok) throw new Error('åˆ é™¤å¤±è´¥');
                showToast('âœ… å·²åˆ é™¤', 'success');
                await loadChefs();
            } catch (err) {
                showToast('åˆ é™¤å¤±è´¥: ' + err.message, 'error');
            }
        }

        // æ›´æ¢ç…§ç‰‡
        function changePhoto(chefId) {
            currentPhotoTarget = chefId;
            document.getElementById('file-input-photo').click();
        }

        // å¤„ç†ç…§ç‰‡ä¸Šä¼ 
        document.getElementById('file-input-photo').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch('/api/upload', {
                    method: 'POST',
                    headers: { 'x-admin-token': adminToken },
                    body: formData
                });

                if (!res.ok) throw new Error('ä¸Šä¼ å¤±è´¥');
                const data = await res.json();

                // æ›´æ–°å›¾ç‰‡
                const row = document.querySelector(`#chefs-tbody tr[data-id="${currentPhotoTarget}"]`);
                row.querySelector('img').src = data.url;

                await updateChef(currentPhotoTarget);
                showToast('âœ… ç…§ç‰‡å·²æ›´æ–°', 'success');
            } catch (err) {
                showToast('ä¸Šä¼ å¤±è´¥: ' + err.message, 'error');
            }

            e.target.value = '';
        });

        // å¯¼å‡ºèœå“
        function exportDishes() {
            fetch('/api/admin/dishes', { headers: getHeaders() })
                .then(res => res.json())
                .then(data => {
                    const csv = dishesToCSV(data.dishes);
                    downloadCSV(csv, 'dishes.csv');
                    showToast('âœ… å·²å¯¼å‡º', 'success');
                });
        }

        // å¯¼å‡ºå¨å¸ˆ
        function exportChefs() {
            fetch('/api/admin/chefs', { headers: getHeaders() })
                .then(res => res.json())
                .then(data => {
                    const csv = chefsToCSV(data.chefs);
                    downloadCSV(csv, 'chefs.csv');
                    showToast('âœ… å·²å¯¼å‡º', 'success');
                });
        }

        // å¯¼å‡ºæ‰€æœ‰æ•°æ®
        async function exportAllData() {
            try {
                const [configRes, dishesRes, chefsRes] = await Promise.all([
                    fetch('/api/admin/config', { headers: getHeaders() }),
                    fetch('/api/admin/dishes', { headers: getHeaders() }),
                    fetch('/api/admin/chefs', { headers: getHeaders() })
                ]);

                const [config, dishes, chefs] = await Promise.all([
                    configRes.json(),
                    dishesRes.json(),
                    chefsRes.json()
                ]);

                const allData = {
                    config: config.config,
                    dishes: dishes.dishes,
                    chefs: chefs.chefs,
                    exported_at: new Date().toISOString()
                };

                const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `restaurant-data-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                showToast('âœ… å·²å¯¼å‡ºæ‰€æœ‰æ•°æ®', 'success');
            } catch (err) {
                showToast('å¯¼å‡ºå¤±è´¥: ' + err.message, 'error');
            }
        }

        // CSV è½¬æ¢
        function dishesToCSV(dishes) {
            const headers = ['ID', 'èœå“åç§°', 'å¨å¸ˆ', 'ç‚¹èµæ•°', 'è¸©æ•°'];
            const rows = dishes.map(d => [d.id, d.name, d.chef, d.up_votes, d.down_votes]);
            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }

        function chefsToCSV(chefs) {
            const headers = ['ID', 'å§“å', 'èŒä½', 'ç®€ä»‹', 'æ—¥æ¦œ', 'æœˆæ¦œ', 'æœˆç¥¨', 'ç…§ç‰‡'];
            const rows = chefs.map(c => [c.id, c.name, c.role, c.description, c.daily_rank, c.monthly_rank, c.monthly_votes, c.photo]);
            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }

        function downloadCSV(csv, filename) {
            const BOM = '\uFEFF';  // UTF-8 BOM
            const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // æ‰¹é‡å¯¼å…¥ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function importDishes() {
            alert('æ‰¹é‡å¯¼å…¥åŠŸèƒ½ï¼š\nè¯·å‡†å¤‡CSVæ–‡ä»¶ï¼Œæ ¼å¼ï¼šèœå“åç§°,å¨å¸ˆ,ç‚¹èµæ•°,è¸©æ•°\nç„¶åé€‰æ‹©æ–‡ä»¶å¯¼å…¥ã€‚');
            document.getElementById('file-input-dishes').click();
        }

        function importChefs() {
            alert('æ‰¹é‡å¯¼å…¥åŠŸèƒ½ï¼š\nè¯·å‡†å¤‡CSVæ–‡ä»¶ï¼Œæ ¼å¼ï¼šå§“å,èŒä½,ç®€ä»‹,æ—¥æ¦œ,æœˆæ¦œ,æœˆç¥¨\nç„¶åé€‰æ‹©æ–‡ä»¶å¯¼å…¥ã€‚');
            document.getElementById('file-input-chefs').click();
        }

        // é‡ç½®å¯†é’¥
        function resetToken() {
            if (confirm('ç¡®å®šè¦é‡ç½®è®¿é—®å¯†é’¥å—ï¼Ÿ')) {
                localStorage.removeItem('admin_token');
                location.reload();
            }
        }

        // æ˜¾ç¤ºæç¤º
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        // åˆå§‹åŒ–
        // --- æ™ºèƒ½å¯¼å…¥åŠŸèƒ½ (å¢å¼ºç‰ˆ) ---
        function openSmartImport() {
            document.getElementById('smart-import-modal').style.display = 'flex';
            document.getElementById('import-text').value = '';
            document.getElementById('import-preview').style.display = 'none';
        }
        
        let parsedDishes = [];
        
        function parseMenuText() {
            const text = document.getElementById('import-text').value;
            if (!text.trim()) { showToast('è¯·å…ˆç²˜è´´æ–‡æœ¬', 'error'); return; }
        
            const lines = text.split('\n');
            parsedDishes = [];
            
            // 1. å®šä¹‰å¿½ç•¥å…³é”®è¯ (ä¸¥æ ¼é»‘åå•)
            const ignoreKeywords = new Set([
                'SVé¤å…', 'ç¾é£Ÿæ¨è', 'æœ¬å‘¨', 'ä¸»å¨', 'å‰¯å¨', 'é¢æ¡£', 'æ˜æ¡£',
                'è¤èœ', 'ç´ èœ', 'ç²—ç²®', 'é²œæ¦¨', 'æœæ±', 'ä¸»é£Ÿ', 'æ±¤ç±»', 'é¢é£Ÿ',
                'æ¸©é¦¨æç¤º', 'å……å€¼', 'æ¥å£äºº', 'æ—¶é—´', 'ä½™é¢', 'æµªè´¹', 'å…‰ç›˜',
                'å»ºè®®', 'æ„‰å¿«', 'æ¬¢è¿', 'æä¾›', 'å®è´µ', 'å…³æ³¨', 'åŠæ—¶', 'åˆç†',
                'æ‹¿å–', 'æ‹’ç»', 'å€¡å¯¼', 'å·¥ä½œæ—¥', 'å‘¨æ—¥', 'å‘¨å››', 'ä¸Šåˆ', 'ä¸‹åˆ',
                '9am', '5pm', 'WX', 'ç›ä¸½', 'é¤å¡', 'ä¼™ä¼´ä»¬', 'money', 'ğŸ’°',
                'å¤ªé˜³', 'ç«ç‘°', 'æ‚ç²®é¥­', 'é¦’å¤´' // ä¸»é£Ÿä¸€èˆ¬ä¸å‚ä¸æŠ•ç¥¨ï¼Œä¹Ÿå¯ä»¥å±è”½
            ]);
        
            // 2. æå–å¨å¸ˆä¿¡æ¯
            let mainChef = 'å½“æ—¥å¨å¸ˆ'; // é»˜è®¤ä¸»å¨
            let noodleChef = '';       // é¢æ¡£å¸ˆå‚…
        
            // é¢„æ‰«æä¸€éæ‰¾å¨å¸ˆ
            lines.forEach(line => {
                const clean = line.replace(/[:ï¼š]/g, ':');
                if (clean.includes('ä¸»å¨:')) {
                    // æå–å†’å·åçš„ç¬¬ä¸€ä¸ªåå­— (å‡è®¾åå­—åœ¨2-4ä¸ªå­—ä¹‹é—´)
                    const names = clean.split(':')[1].trim().split(/\s+/);
                    if (names[0] && names[0].length < 5) mainChef = names[0];
                }
                if (clean.includes('é¢æ¡£:')) {
                    const names = clean.split(':')[1].trim().split(/\s+/);
                    if (names[0] && names[0].length < 5) noodleChef = names[0];
                }
            });
        
            // å¦‚æœæ²¡æ‰¾åˆ°é¢æ¡£å¸ˆå‚…ï¼Œå°±é»˜è®¤éƒ½å½’ä¸»å¨
            if (!noodleChef) noodleChef = mainChef;
        
            console.log(`è¯†åˆ«åˆ°ä¸»å¨: ${mainChef}, é¢æ¡£: ${noodleChef}`);
        
            // 3. é€è¡Œè§£æèœå“
            let currentChef = mainChef; // å½“å‰ä¸Šä¸‹æ–‡çš„å¨å¸ˆ (é»˜è®¤ä¸ºä¸»å¨)
            let stopParsing = false;    // é‡åˆ°é¡µè„šåœæ­¢è§£ææ ‡å¿—
        
            lines.forEach(line => {
                if (stopParsing) return;
                
                let cleanLine = line.trim();
                if (!cleanLine) return;
        
                // ğŸ›‘ åœæ­¢è§„åˆ™ï¼šé‡åˆ°è¿™äº›è¯ï¼Œè¯´æ˜æ­£æ–‡ç»“æŸäº†ï¼Œåé¢éƒ½æ˜¯åºŸè¯
                if (cleanLine.includes('æ¸©é¦¨æç¤º') || cleanLine.includes('ç¥å¤§å®¶') || cleanLine.includes('æ¬¢è¿å¤§å®¶')) {
                    stopParsing = true;
                    return;
                }
        
                // ğŸ”„ å¨å¸ˆåˆ‡æ¢è§„åˆ™
                // å¦‚æœè¿™ä¸€è¡ŒåŒ…å«â€œé¢é£Ÿâ€æˆ–â€œé¢æ¡£â€ï¼Œæˆ–è€…æ˜¯é¢é£Ÿåˆ†ç±»ä¸‹çš„å†…å®¹ -> åˆ‡æ¢ä¸ºé¢æ¡£å¨å¸ˆ
                if (cleanLine.includes('é¢é£Ÿ') || cleanLine.includes('é¢æ¡£')) {
                    currentChef = noodleChef;
                }
                // å¦‚æœæ˜¯å…¶ä»–åˆ†ç±» (æ˜æ¡£/è¤èœ/ç´ èœç­‰) -> åˆ‡æ¢å›ä¸»å¨
                else if (cleanLine.match(/(æ˜æ¡£|è¤èœ|ç´ èœ|ç²—ç²®|æ±¤ç±»|ä¸»é£Ÿ)/)) {
                    currentChef = mainChef;
                }
        
                // ğŸ§¹ æ¸…ç†è¡Œå†…å®¹ (ä¿ç•™å†’å·åé¢çš„éƒ¨åˆ†ï¼Œå»é™¤å‰ç¼€)
                // ä¾‹å¦‚: "ğŸœé¢é£Ÿ:é¢æ¡" -> "é¢æ¡" ; "ğŸ®:å°ç‚’é»„ç‰›è‚‰" -> "å°ç‚’é»„ç‰›è‚‰"
                cleanLine = cleanLine.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g, '') // å»é™¤Emoji
                                     .replace(/[\[\]]/g, '') // å»é™¤[]
                                     .trim();
        
                // å¦‚æœåŒ…å«å†’å·ï¼Œé€šå¸¸å†’å·å‰æ˜¯åˆ†ç±»ï¼Œå†’å·åæ˜¯èœ
                if (cleanLine.includes(':') || cleanLine.includes('ï¼š')) {
                    const parts = cleanLine.split(/[:ï¼š]/);
                    // å¦‚æœå†’å·åé¢æœ‰å†…å®¹ï¼Œå–å†’å·åé¢çš„ï¼›å¦åˆ™(æ¯”å¦‚"è¤èœï¼š")å–ä¸‹ä¸€è¡Œ
                    if (parts[1] && parts[1].trim()) {
                        cleanLine = parts[1];
                    } else {
                        return; // åªæ˜¯ä¸ªæ ‡é¢˜è¡Œï¼Œè·³è¿‡
                    }
                }
        
                // åˆ†å‰²ä¸€è¡Œä¸­çš„å¤šä¸ªèœå“ (ç©ºæ ¼åˆ†éš”)
                const items = cleanLine.split(/\s+/);
                
                items.forEach(item => {
                    item = item.trim();
                    // ğŸ” è¿‡æ»¤è§„åˆ™ï¼š
                    // 1. é•¿åº¦å¿…é¡»å¤§äº1
                    // 2. ä¸èƒ½åŒ…å«æ•°å­— (è¿‡æ»¤ç”µè¯å·ã€æ—¶é—´ã€é‡‘é¢)
                    // 3. ä¸èƒ½åœ¨é»‘åå•é‡Œ
                    if (item.length > 1 && 
                        !/\d/.test(item) && 
                        !ignoreKeywords.has(item) &&
                        !item.includes('å¾®ä¿¡') &&
                        !item.includes('æ¥å£')) {
                        
                        parsedDishes.push({ name: item, chef: currentChef });
                    }
                });
            });
        
            renderPreview();
        }
        
        function renderPreview() {
            const tbody = document.getElementById('preview-tbody');
            tbody.innerHTML = '';
            document.getElementById('preview-count').textContent = parsedDishes.length;
            
            if (parsedDishes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px; color:#999;">æœªè¯†åˆ«åˆ°æœ‰æ•ˆèœå“ï¼Œè¯·æ£€æŸ¥æ–‡æœ¬æ ¼å¼</td></tr>';
                document.getElementById('import-preview').style.display = 'block';
                return;
            }
        
            parsedDishes.forEach((dish, index) => {
                // æ ¹æ®å¨å¸ˆä¸åŒæ˜¾ç¤ºä¸åŒé¢œè‰²
                const isNoodle = dish.chef !== 'å½“æ—¥å¨å¸ˆ' && dish.chef !== parsedDishes[0].chef; 
                
                tbody.innerHTML += `
                    <tr style="border-bottom:1px solid #eee;">
                        <td style="padding:8px;">
                            <input type="text" value="${dish.name}" class="table-input" onchange="parsedDishes[${index}].name = this.value">
                        </td>
                        <td style="padding:8px;">
                            <input type="text" value="${dish.chef}" class="table-input" onchange="parsedDishes[${index}].chef = this.value" style="${isNoodle ? 'color:#e65100; font-weight:bold;' : ''}">
                        </td>
                        <td style="padding:8px; text-align:center;">
                            <button class="btn btn-danger" style="padding:2px 6px; font-size:12px;" onclick="removeParsedDish(${index})">Ã—</button>
                        </td>
                    </tr>
                `;
            });
            document.getElementById('import-preview').style.display = 'block';
        }
        
        function removeParsedDish(index) {
            parsedDishes.splice(index, 1);
            renderPreview();
        }
        
        async function executeImport() {
            if (!confirm(`ç¡®è®¤å¯¼å…¥ ${parsedDishes.length} é“èœå“å—ï¼Ÿ`)) return;
            
            let count = 0;
            // åè½¬æ•°ç»„ï¼Œè®©èœå•é¡¶éƒ¨çš„èœåœ¨æ•°æ®åº“é‡Œä¹Ÿé å‰ (å¦‚æœæ˜¯è‡ªå¢IDçš„è¯)
            // æˆ–è€…ä¿æŒåŸæ ·ã€‚è¿™é‡Œä¿æŒåŸæ ·ã€‚
            for (const dish of parsedDishes) {
                try {
                    await fetch('/api/admin/dishes', {
                        method: 'POST',
                        headers: getHeaders(),
                        body: JSON.stringify({
                            name: dish.name,
                            chef: dish.chef,
                            up_votes: 0,
                            down_votes: 0
                        })
                    });
                    count++;
                } catch (e) { console.error(e); }
            }
            
            showToast(`æˆåŠŸå¯¼å…¥ ${count} é“èœå“`, 'success');
            document.getElementById('smart-import-modal').style.display = 'none';
            loadDishes(); // åˆ·æ–°åˆ—è¡¨
        }
        // --- æ™ºèƒ½å¯¼å…¥åŠŸèƒ½ (å¢å¼ºç‰ˆ) ---END
        
        init();
    </script>
</body>
</html>
